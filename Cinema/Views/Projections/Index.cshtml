@model IEnumerable<Cinema.Models.Projection>

@{
    ViewData["Title"] = "Projections";
    var ticketsCount = ViewData["TicketsCount"] as Dictionary<int, int>;
}

<link rel="stylesheet" href="~/css/projections.css" />

<div class="overlay py-5">
    <div class="container fade-in">
        <h1 class="cinema-title mb-5 text-center">Projections</h1>

        <p class="text-center mb-4">
            @if (ViewBag.IsAdminView == true)
            {
                <a asp-action="Create" class="btn btn-action">Create New Projection</a>
            }
        </p>

        <form asp-action="Index" method="get" class="search-form d-flex mb-4 align-items-center gap-2 justify-content-center flex-wrap">
            <input type="text" name="searchString" value="@ViewBag.CurrentFilter" placeholder="Search by movie title..." />

            <select name="sortOrder" asp-items="ViewBag.SortOptions">
            </select>

            <button type="submit" class="btn btn-action">Search / Sort</button>
            <a href="@Url.Action("Index")" class="btn btn-clear">Clear</a>
        </form>

        <div class="table-responsive">
            <table class="table table-dark table-striped align-middle projection-table">
                <thead>
                    <tr class="text-gold">
                        <th>Movie</th>
                        <th>Hall</th>
                        <th>Time</th>
                        <th>Ticket Price</th>
                        <th>Available Seats</th>
                        <th>Taken Seats</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        var takenSeats = ticketsCount != null && ticketsCount.ContainsKey(item.Id) ? ticketsCount[item.Id] : 0;
                        var totalSeats = item.Hall.Rows * item.Hall.Columns;
                        var availableSeats = totalSeats - takenSeats;
                        var basePrice = item.TicketPrice;
                        var ticketTypes = new List<(string Name, decimal Multiplier)>
                                        {
                                        ("Regular", 1.0m),
                                        ("Kid", 0.5m),
                                        ("Student", 0.75m)
                                        };
                        <tr class="projection-row">
                            <td>@item.Movie?.Title</td>
                            <td>@item.Hall?.Name</td>
                            <td>@item.ProjectionTime.ToString("dd.MM.yyyy HH:mm")</td>
                            <td>
                                @foreach (var type in ticketTypes)
                                {
                                    var finalPrice = basePrice * type.Multiplier;
                                    <div>@type.Name: @finalPrice.ToString("C")</div>
                                }
                            </td>
                            <td>@availableSeats</td>
                            <td>@takenSeats</td>
                            <td>
                                @if (ViewBag.IsAdminView == null || ViewBag.IsAdminView == false)
                                {
                                    <a asp-controller="Tickets" asp-action="Create" asp-route-projectionId="@item.Id" class="btn btn-buy btn-sm me-1 mb-1">
                                        <i class="bi bi-cart-plus"></i> Buy
                                    </a>
                                }
                                @if (ViewBag.IsAdminView == true)
                                {
                                    <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-action btn-sm mb-1">
                                        <i class="bi bi-info-circle"></i> Details
                                    </a>
                                    <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-action btn-sm me-1 mb-1">
                                        <i class="bi bi-pencil-square"></i> Edit
                                    </a>
                                    <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-action btn-sm me-1 mb-1">
                                        <i class="bi bi-trash"></i> Delete
                                    </a>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>