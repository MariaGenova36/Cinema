@model Cinema.Models.Ticket

@{
    ViewData["Title"] = "Reserve Seat";
    var projection = ViewBag.Projection as Cinema.Models.Projection;
    if (projection == null)
    {
        <div class="alert alert-danger">Projection not found.</div>
        return;
    }

    var takenSeats = (ViewBag.TakenSeats as IEnumerable<dynamic>) ?? Enumerable.Empty<dynamic>();
}

<link rel="stylesheet" href="~/css/createreservation.css" />

<h2 class="mb-4">Reserve a Seat</h2>

<div class="mb-3 p-3 bg-dark text-white border rounded shadow-sm">
    <strong>Movie:</strong> @projection.Movie.Title <br />
    <strong>Time:</strong> @projection.ProjectionTime.ToString("dd.MM.yyyy HH:mm") <br />
    <strong>Hall:</strong> @projection.Hall.Name
</div>

@if (!(ViewBag.IsAdmin as bool? ?? false) && (ViewBag.UserTicketsCount as int? ?? 0) >= 3)
{
    <div class="alert alert-warning">
        You have already reserved the maximum of 3 tickets for this projection.
    </div>
}
else
{
    <form asp-action="CreateTemp" method="post" onsubmit="return validateSeatSelection();">
        <input type="hidden" asp-for="ProjectionId" />
        <input type="hidden" id="SeatRows" name="SeatRows" />
        <input type="hidden" id="SeatCols" name="SeatCols" />
        <input type="hidden" id="TicketMultiplier" name="TicketMultiplier" value="1" />

        <h4 class="mt-4">Select Seats</h4>

        <div class="screen-indicator mb-3">
            Screen
        </div>

        <div class="d-flex justify-content-center">
            <div class="seat-grid-wrapper mb-3">
                @for (int row = 1; row <= projection.Hall.Rows; row++)
                {
                    <div class="seat-row">
                        @for (int col = 1; col <= projection.Hall.Columns; col++)
                        {
                            bool isTaken = takenSeats.Any(s => (int)s.SeatRow == row && (int)s.SeatColumn == col);

                            if (isTaken)
                            {
                                <button type="button" class="seat-btn seat-taken" disabled>@row-@col</button>
                            }
                            else
                            {
                                <button type="button" class="seat-btn seat-available" data-row="@row" data-col="@col">@row-@col</button>
                            }
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Легенда -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-box" style="background:#28a745;"></div> Free
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background:#dc3545;"></div> Taken
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background:#0d6efd;"></div> Selected
            </div>
        </div>

        <div class="mt-4">
            <label class="fw-bold">Type of ticket:</label>
            <select id="ticketTypeSelect" name="TicketType" class="form-select w-auto d-inline-block ms-2">
                @foreach (var type in ViewBag.TicketTypes as IEnumerable<dynamic>)
                {
                    <option value="@type.Name"
                            data-multiplier="@type.Multiplier.ToString(System.Globalization.CultureInfo.InvariantCulture)">
                        @type.Name
                    </option>
                }
            </select>
        </div>

        <div class="mt-3 p-3 bg-dark text-white rounded w-auto d-inline-block shadow-sm price-box">
            <strong>Price:</strong>
            <span id="ticketPrice"
                  data-baseprice="@projection.TicketPrice.ToString(System.Globalization.CultureInfo.InvariantCulture)">
            </span>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-reserve me-2">
                 Reserve
            </button>
            <a asp-controller="Projections" asp-action="Index" class="btn btn-secondary">
                 Cancel
            </a>
        </div>
    </form>
}