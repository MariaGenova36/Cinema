@model Cinema.Models.Ticket

@{
    ViewData["Title"] = "Reserve Seat";
    var projection = ViewBag.Projection as Cinema.Models.Projection;
    // Ако ViewBag.TakenSeats е null, ползвай празна колекция.
    var takenSeats = (ViewBag.TakenSeats as IEnumerable<dynamic>) ?? Enumerable.Empty<dynamic>();
}
<h2>Reserve a Seat</h2>

<div class="mb-3">
    <strong>Movie:</strong> @projection.Movie.Title <br />
    <strong>Time:</strong> @projection.ProjectionTime.ToString("dd.MM.yyyy HH:mm") <br />
    <strong>Hall:</strong> @projection.Hall.Name
</div>

<form asp-action="Create" method="post">
    <input type="hidden" asp-for="ProjectionId" />
    <input type="hidden" id="SeatRow" name="SeatRow" />
    <input type="hidden" id="SeatColumn" name="SeatColumn" />

    <h4>Select a Seat</h4>

    <!-- ЕКРАН -->
    <div class="screen-indicator mb-3 text-center p-2 bg-secondary text-white rounded">
        ЕКРАН
    </div>

    <!-- СЕДАЛКИ -->
    <div class="d-flex justify-content-center">
        <div class="seat-grid-wrapper mb-3 p-3 bg-light border rounded">
            @for (int row = 1; row <= projection.Hall.Rows; row++)
            {
                <div class="d-flex mb-1">
                    @for (int col = 1; col <= projection.Hall.Columns; col++)
                    {
                        bool isTaken = takenSeats.Any(s => (int)s.SeatRow == row && (int)s.SeatColumn == col);

                        if (isTaken)
                        {
                            <button type="button" class="btn btn-danger btn-sm me-1 mb-1" disabled>
                                @row-@col
                            </button>
                        }
                        else
                        {
                            <button type="button" class="btn btn-outline-success btn-sm me-1 mb-1 seat-btn"
                                    data-row="@row" data-col="@col">
                                @row-@col
                            </button>
                        }
                    }
                </div>
            }
        </div>
    </div>

    <div class="mt-3">
        <button type="submit" class="btn btn-primary">Reserve</button>
        <a asp-controller="Projections" asp-action="Index" class="btn btn-secondary">Cancel</a>
    </div>
</form>


@section Scripts {
    <script>
        const seatButtons = document.querySelectorAll('.seat-btn');
        const seatRowInput = document.getElementById('SeatRow');
        const seatColInput = document.getElementById('SeatColumn');

        seatButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                // Clear old selection
                seatButtons.forEach(b => b.classList.remove('btn-success'));
                btn.classList.add('btn-success');

                // Set selected seat values
                seatRowInput.value = btn.dataset.row;
                seatColInput.value = btn.dataset.col;
            });
        });
    </script>
}
